<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Exam Proctoring System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1f2937;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .login-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .form-input {
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 70, 229, 0.3);
        }
        
        .metric-card {
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
        }
        
        .alert-pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        
        .connection-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .connected { background-color: var(--success); }
        .connecting { background-color: var(--warning); }
        .disconnected { background-color: var(--danger); }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-real { background: rgba(34, 197, 94, 0.2); color: var(--success); border: 1px solid var(--success); }
        .status-simulated { background: rgba(245, 158, 11, 0.2); color: var(--warning); border: 1px solid var(--warning); }
        
        .progress-bar {
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .floating-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            animation: slideIn 0.5s ease-out;
        }
        
        .camera-preview {
            border-radius: 12px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.7);
        }
        
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
        }
        
        .step {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.3);
            margin: 0 8px;
            transition: all 0.3s ease;
        }
        
        .step.active {
            background-color: white;
            transform: scale(1.2);
        }
        
        .step.completed {
            background-color: var(--success);
        }
        
        .video-container {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
        }
        
        .video-feed {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }
        
        .camera-permission {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Login Page -->
    <div id="login-page" class="min-h-screen flex items-center justify-center p-4 fade-in">
        <div class="login-container rounded-3xl p-8 w-full max-w-md">
            <!-- Header -->
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-graduation-cap text-white text-2xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Secure Exam Proctor</h1>
                <p class="text-gray-600">AI-powered online examination monitoring</p>
            </div>

            <!-- Login Form -->
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-envelope mr-2"></i>Email Address
                    </label>
                    <input 
                        type="email" 
                        id="email" 
                        required
                        class="form-input w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="student@university.edu"
                    >
                </div>

                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-lock mr-2"></i>Password
                    </label>
                    <input 
                        type="password" 
                        id="password" 
                        required
                        class="form-input w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Enter your password"
                    >
                </div>

                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input 
                            type="checkbox" 
                            id="remember-me"
                            class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                        >
                        <label for="remember-me" class="ml-2 text-sm text-gray-600">Remember me</label>
                    </div>
                    <a href="#" class="text-sm text-blue-600 hover:text-blue-500">Forgot password?</a>
                </div>

                <button 
                    type="submit"
                    class="btn-primary w-full text-white py-3 px-4 rounded-xl font-semibold shadow-lg"
                >
                    <i class="fas fa-sign-in-alt mr-2"></i>Sign In to Exam
                </button>
            </form>

            <!-- Demo Accounts -->
            <div class="mt-6 p-4 bg-gray-100 rounded-xl">
                <h4 class="font-semibold text-gray-700 mb-3 text-center">Demo Accounts (Click to Auto-fill)</h4>
                <div class="grid grid-cols-2 gap-2">
                    <button class="demo-account-btn bg-blue-500 hover:bg-blue-600 text-white py-2 px-3 rounded-lg text-sm transition-colors" data-email="student1@university.edu" data-password="password123">
                        Student 1
                    </button>
                    <button class="demo-account-btn bg-green-500 hover:bg-green-600 text-white py-2 px-3 rounded-lg text-sm transition-colors" data-email="demo@student.edu" data-password="demo123">
                        Demo Student
                    </button>
                </div>
            </div>

            <!-- Server Status -->
            <div class="mt-6 p-4 bg-yellow-50 rounded-xl border border-yellow-200">
                <h3 class="font-semibold text-yellow-800 mb-2 flex items-center">
                    <i class="fas fa-server mr-2"></i>Server Status
                </h3>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-yellow-700">WebSocket Connection:</span>
                    <span id="server-status" class="text-sm font-semibold text-yellow-600">Not Connected</span>
                </div>
                <button id="test-connection-btn" class="w-full mt-3 bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded-lg text-sm transition-colors">
                    <i class="fas fa-plug mr-2"></i>Test Server Connection
                </button>
            </div>

            <!-- Camera Status -->
            <div class="mt-6 p-4 bg-blue-50 rounded-xl border border-blue-200">
                <h3 class="font-semibold text-blue-800 mb-2 flex items-center">
                    <i class="fas fa-camera mr-2"></i>Camera Status
                </h3>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-blue-700">Camera Access:</span>
                    <span id="camera-status-login" class="text-sm font-semibold text-blue-600">Checking...</span>
                </div>
                <button id="test-camera-btn" class="w-full mt-3 bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg text-sm transition-colors">
                    <i class="fas fa-camera mr-2"></i>Test Camera Access
                </button>
            </div>

            <!-- Exam Information -->
            <div class="mt-8 p-4 bg-blue-50 rounded-xl border border-blue-200">
                <h3 class="font-semibold text-blue-800 mb-2 flex items-center">
                    <i class="fas fa-info-circle mr-2"></i>Exam Requirements
                </h3>
                <ul class="text-sm text-blue-700 space-y-1">
                    <li>• Stable internet connection required</li>
                    <li>• Webcam and microphone access</li>
                    <li>• No external devices allowed</li>
                    <li>• Well-lit environment</li>
                </ul>
            </div>

            <!-- Footer -->
            <div class="mt-8 text-center">
                <p class="text-gray-500 text-sm">
                    By signing in, you agree to our
                    <a href="#" class="text-blue-600 hover:text-blue-500">Terms of Service</a>
                    and
                    <a href="#" class="text-blue-600 hover:text-blue-500">Privacy Policy</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Setup Wizard -->
    <div id="setup-wizard" class="min-h-screen hidden items-center justify-center p-4 bg-gradient-to-br from-blue-600 to-purple-700">
        <div class="login-container rounded-3xl p-8 w-full max-w-2xl">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-camera text-blue-600 text-2xl"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Setup Your Exam Environment</h1>
                <p class="text-gray-600">We need to verify your environment before starting the exam</p>
            </div>
            
            <!-- Step Indicator -->
            <div class="step-indicator">
                <div class="step active" id="step-1-indicator"></div>
                <div class="step" id="step-2-indicator"></div>
                <div class="step" id="step-3-indicator"></div>
                <div class="step" id="step-4-indicator"></div>
            </div>
            
            <!-- Step 1: Welcome -->
            <div id="step-1" class="step-content fade-in">
                <div class="text-center py-8">
                    <i class="fas fa-user-check text-5xl text-blue-500 mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Welcome, <span id="setup-user-name">Student</span>!</h2>
                    <p class="text-gray-600 mb-6">Before we begin your exam, we need to verify your identity and environment.</p>
                    <p class="text-gray-600 mb-8">This process will take about 2 minutes and includes:</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                        <div class="bg-blue-50 p-4 rounded-xl">
                            <i class="fas fa-camera text-blue-500 text-xl mb-2"></i>
                            <h3 class="font-semibold text-gray-800">Camera Check</h3>
                            <p class="text-sm text-gray-600">Verify your camera is working</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-xl">
                            <i class="fas fa-microphone text-green-500 text-xl mb-2"></i>
                            <h3 class="font-semibold text-gray-800">Microphone Check</h3>
                            <p class="text-sm text-gray-600">Test your audio input</p>
                        </div>
                        <div class="bg-purple-50 p-4 rounded-xl">
                            <i class="fas fa-network-wired text-purple-500 text-xl mb-2"></i>
                            <h3 class="font-semibold text-gray-800">Connection Test</h3>
                            <p class="text-sm text-gray-600">Ensure stable connection</p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-xl">
                            <i class="fas fa-id-card text-yellow-500 text-xl mb-2"></i>
                            <h3 class="font-semibold text-gray-800">ID Verification</h3>
                            <p class="text-sm text-gray-600">Confirm your identity</p>
                        </div>
                    </div>
                    
                    <button id="start-setup-btn" class="btn-primary text-white py-3 px-8 rounded-xl font-semibold shadow-lg">
                        Start Setup <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 2: Camera Access -->
            <div id="step-2" class="step-content hidden">
                <div class="text-center py-4">
                    <i class="fas fa-camera text-5xl text-blue-500 mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Camera Access</h2>
                    <p class="text-gray-600 mb-6">We need access to your camera for identity verification and proctoring.</p>
                    
                    <div class="camera-preview mx-auto max-w-md h-64 mb-6 flex items-center justify-center">
                        <div id="camera-placeholder" class="text-center text-gray-500">
                            <i class="fas fa-camera fa-3x mb-3"></i>
                            <p>Camera preview will appear here</p>
                        </div>
                        <video id="camera-preview" class="w-full h-full object-cover hidden"></video>
                    </div>
                    
                    <div class="flex justify-center space-x-4">
                        <button id="request-camera-btn" class="btn-primary text-white py-3 px-6 rounded-xl font-semibold">
                            <i class="fas fa-camera mr-2"></i>Allow Camera Access
                        </button>
                        <button id="skip-camera-btn" class="bg-gray-500 hover:bg-gray-600 text-white py-3 px-6 rounded-xl font-semibold transition-colors">
                            Skip for Now
                        </button>
                    </div>
                    
                    <p class="text-sm text-gray-500 mt-4">Note: Camera access is required for proctored exams</p>
                </div>
            </div>
            
            <!-- Step 3: Environment Check -->
            <div id="step-3" class="step-content hidden">
                <div class="text-center py-4">
                    <i class="fas fa-lightbulb text-5xl text-yellow-500 mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Environment Check</h2>
                    <p class="text-gray-600 mb-6">Please ensure your environment meets these requirements:</p>
                    
                    <div class="grid grid-cols-1 gap-4 mb-8 max-w-md mx-auto">
                        <div class="bg-white p-4 rounded-xl border border-gray-200 flex items-start">
                            <i class="fas fa-sun text-yellow-500 text-xl mt-1 mr-4"></i>
                            <div class="text-left">
                                <h3 class="font-semibold text-gray-800">Good Lighting</h3>
                                <p class="text-sm text-gray-600">Your face should be clearly visible</p>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl border border-gray-200 flex items-start">
                            <i class="fas fa-user-friends text-blue-500 text-xl mt-1 mr-4"></i>
                            <div class="text-left">
                                <h3 class="font-semibold text-gray-800">Alone in Room</h3>
                                <p class="text-sm text-gray-600">No other people should be present</p>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl border border-gray-200 flex items-start">
                            <i class="fas fa-ban text-red-500 text-xl mt-1 mr-4"></i>
                            <div class="text-left">
                                <h3 class="font-semibold text-gray-800">No External Devices</h3>
                                <p class="text-sm text-gray-600">Phones, tablets, or other devices not allowed</p>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl border border-gray-200 flex items-start">
                            <i class="fas fa-desktop text-green-500 text-xl mt-1 mr-4"></i>
                            <div class="text-left">
                                <h3 class="font-semibold text-gray-800">Clear Workspace</h3>
                                <p class="text-sm text-gray-600">Only exam materials on your desk</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center justify-center mb-6">
                        <input type="checkbox" id="environment-confirm" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                        <label for="environment-confirm" class="ml-2 text-gray-700 font-medium">I confirm my environment meets these requirements</label>
                    </div>
                    
                    <button id="environment-next-btn" class="btn-primary text-white py-3 px-8 rounded-xl font-semibold shadow-lg" disabled>
                        Continue <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
            
            <!-- Step 4: Final Verification -->
            <div id="step-4" class="step-content hidden">
                <div class="text-center py-8">
                    <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Ready to Begin!</h2>
                    <p class="text-gray-600 mb-6">Your exam environment has been verified successfully.</p>
                    
                    <div class="bg-green-50 border border-green-200 rounded-xl p-6 max-w-md mx-auto mb-8">
                        <h3 class="font-semibold text-green-800 mb-4">Exam Details</h3>
                        <div class="text-left space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-700">Exam:</span>
                                <span class="font-semibold" id="setup-exam-name">Computer Science Final</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-700">Duration:</span>
                                <span class="font-semibold" id="setup-exam-duration">02:00:00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-700">Questions:</span>
                                <span class="font-semibold" id="setup-exam-questions">50</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-700">Proctoring:</span>
                                <span class="font-semibold text-green-600">ACTIVE</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-sm text-gray-500 mb-8">
                        <p>Once you begin, the exam timer will start and cannot be paused.</p>
                        <p>Any suspicious activity will be flagged for review.</p>
                    </div>
                    
                    <button id="start-exam-btn" class="btn-primary text-white py-3 px-8 rounded-xl font-semibold shadow-lg text-lg">
                        <i class="fas fa-play-circle mr-2"></i>Start Exam
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="min-h-screen hidden p-4">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="glass-card rounded-2xl p-6 mb-6">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                    <div class="mb-4 md:mb-0">
                        <h1 class="text-2xl md:text-3xl font-bold text-white">
                            <i class="fas fa-graduation-cap mr-3"></i>
                            AI Exam Proctoring System
                        </h1>
                        <p class="text-gray-200 mt-2">Welcome, <span id="user-name" class="font-semibold">Student</span> | <span id="exam-name" class="font-semibold">Computer Science Final</span></p>
                    </div>
                    <div class="text-right">
                        <div id="connection-status" class="text-green-300 font-semibold flex items-center justify-end">
                            <span class="connection-dot connected"></span>
                            System Connected
                        </div>
                        <div class="text-gray-200 text-sm mt-1">
                            Time: <span id="current-time">00:00:00</span> | 
                            Session: <span id="session-timer">00:00:00</span>
                        </div>
                        <button id="logout-btn" class="mt-2 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-colors">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left Column - Video Feed -->
                <div class="lg:col-span-2 space-y-6">
                    <!-- Video Feed -->
                    <div class="glass-card rounded-2xl p-6">
                        <h2 class="text-xl font-semibold text-white mb-4">
                            <i class="fas fa-video mr-2"></i>Live Proctoring Feed
                        </h2>
                        <div class="video-container">
                            <video id="webcam-video" autoplay playsinline class="video-feed hidden"></video>
                            <canvas id="webcam-canvas" class="video-feed hidden"></canvas>
                            <div id="video-placeholder" class="video-feed camera-permission text-white text-center">
                                <i class="fas fa-camera fa-3x mb-3"></i>
                                <p class="text-lg font-semibold mb-2">Camera Access Required</p>
                                <p class="text-sm mb-4">Please allow camera access to begin proctoring</p>
                                <button id="enable-camera-btn" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg">
                                    <i class="fas fa-camera mr-2"></i>Enable Camera
                                </button>
                            </div>
                            <div class="absolute top-4 right-4 bg-red-500 text-white px-3 py-1 rounded-full text-sm font-semibold flex items-center">
                                <i class="fas fa-circle mr-2 animate-pulse"></i>
                                LIVE
                            </div>
                        </div>
                        
                        <!-- Connection Info -->
                        <div class="mt-4 flex justify-between items-center text-sm">
                            <div class="text-gray-300">
                                <span id="data-status">Waiting for data...</span>
                            </div>
                            <div class="text-gray-300">
                                FPS: <span id="fps-display">0</span> | 
                                Camera: <span id="camera-status-dashboard">Checking...</span>
                            </div>
                        </div>
                    </div>

                    <!-- System Status -->
                    <div class="glass-card rounded-2xl p-4">
                        <h3 class="text-lg font-semibold text-white mb-2">System Status</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="flex items-center">
                                <span class="text-gray-300 mr-2">Detection:</span>
                                <span id="detection-status" class="font-semibold text-yellow-400">Initializing...</span>
                            </div>
                            <div class="flex items-center">
                                <span class="text-gray-300 mr-2">Faces Found:</span>
                                <span id="faces-count" class="font-semibold text-blue-400">0</span>
                            </div>
                            <div class="flex items-center">
                                <span class="text-gray-300 mr-2">Frame Rate:</span>
                                <span id="fps-display-main" class="font-semibold text-green-400">0 FPS</span>
                            </div>
                            <div class="flex items-center">
                                <span class="text-gray-300 mr-2">Stability:</span>
                                <span id="stable-frames" class="font-semibold text-purple-400">0 frames</span>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Log -->
                    <div class="glass-card rounded-2xl p-6">
                        <h2 class="text-xl font-semibold text-white mb-4">
                            <i class="fas fa-list-alt mr-2"></i>Proctoring Activity Log
                        </h2>
                        <div id="activity-log" class="bg-gray-900 rounded-lg p-4 h-64 overflow-y-auto text-sm">
                            <div class="text-gray-400 text-center py-8">
                                <i class="fas fa-clock fa-2x mb-2"></i>
                                <p>Waiting for activity data...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Metrics & Alerts -->
                <div class="space-y-6">
                    <!-- Alert Status -->
                    <div id="alert-panel" class="glass-card rounded-2xl p-6 bg-green-500/20 border-green-400/30">
                        <h2 class="text-xl font-semibold text-white mb-4">
                            <i class="fas fa-shield-alt mr-2"></i>Security Status
                        </h2>
                        <div class="text-center py-6">
                            <i class="fas fa-check-circle text-5xl text-green-400 mb-4"></i>
                            <h3 id="alert-status" class="text-2xl font-bold text-green-400 mb-2">ALL CLEAR</h3>
                            <p id="alert-message" class="text-green-300">No suspicious activity detected</p>
                        </div>
                    </div>

                    <!-- Real-time Metrics -->
                    <div class="glass-card rounded-2xl p-6">
                        <h2 class="text-xl font-semibold text-white mb-4">
                            <i class="fas fa-chart-line mr-2"></i>Real-time Metrics
                        </h2>
                        <div class="space-y-4">
                            <!-- Head Pose -->
                            <div class="metric-card bg-white/10 rounded-xl p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-gray-200 font-medium">
                                        <i class="fas fa-user mr-2"></i>Head Pose
                                    </span>
                                    <span id="head-yaw-value" class="text-2xl font-bold text-green-400">0.0°</span>
                                </div>
                                <div class="progress-bar">
                                    <div id="head-yaw-bar" class="progress-fill bg-green-400" style="width: 50%"></div>
                                </div>
                                <div class="text-xs text-gray-400 flex justify-between mt-1">
                                    <span>Centered</span>
                                    <span>Looking Away</span>
                                </div>
                            </div>

                            <!-- Eye Gaze -->
                            <div class="metric-card bg-white/10 rounded-xl p-4">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-gray-200 font-medium">
                                        <i class="fas fa-eye mr-2"></i>Eye Gaze
                                    </span>
                                    <span id="gaze-deviation-value" class="text-2xl font-bold text-green-400">0.000</span>
                                </div>
                                <div class="progress-bar">
                                    <div id="gaze-deviation-bar" class="progress-fill bg-green-400" style="width: 50%"></div>
                                </div>
                                <div class="text-xs text-gray-400 flex justify-between mt-1">
                                    <span>Focused</span>
                                    <span>Distracted</span>
                                </div>
                            </div>

                            <!-- Device Detection -->
                            <div class="metric-card bg-white/10 rounded-xl p-4">
                                <div class="flex justify-between items-center">
                                    <span class="text-gray-200 font-medium">
                                        <i class="fas fa-mobile-alt mr-2"></i>Device Detection
                                    </span>
                                    <span id="device-status" class="text-2xl font-bold text-green-400">CLEAR</span>
                                </div>
                                <div class="mt-2 text-xs text-gray-400">
                                    No unauthorized devices detected
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Exam Information -->
                    <div class="glass-card rounded-2xl p-6">
                        <h2 class="text-xl font-semibold text-white mb-4">
                            <i class="fas fa-info-circle mr-2"></i>Exam Information
                        </h2>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between text-gray-200">
                                <span>Exam:</span>
                                <span class="font-semibold" id="exam-title">Computer Science Final</span>
                            </div>
                            <div class="flex justify-between text-gray-200">
                                <span>Duration:</span>
                                <span class="font-semibold" id="exam-duration">02:00:00</span>
                            </div>
                            <div class="flex justify-between text-gray-200">
                                <span>Questions:</span>
                                <span class="font-semibold" id="exam-questions">50</span>
                            </div>
                            <div class="flex justify-between text-gray-200">
                                <span>Status:</span>
                                <span class="font-semibold text-green-400" id="exam-status">In Progress</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="glass-card rounded-2xl p-6">
                        <h2 class="text-xl font-semibold text-white mb-4">
                            <i class="fas fa-cogs mr-2"></i>Quick Actions
                        </h2>
                        <div class="grid grid-cols-2 gap-3">
                            <button class="bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-xl font-semibold transition-colors flex items-center justify-center">
                                <i class="fas fa-flag mr-2"></i>Flag Issue
                            </button>
                            <button class="bg-purple-500 hover:bg-purple-600 text-white py-3 px-4 rounded-xl font-semibold transition-colors flex items-center justify-center">
                                <i class="fas fa-pause mr-2"></i>Pause
                            </button>
                            <button class="bg-yellow-500 hover:bg-yellow-600 text-white py-3 px-4 rounded-xl font-semibold transition-colors flex items-center justify-center">
                                <i class="fas fa-comment mr-2"></i>Help
                            </button>
                            <button class="bg-red-500 hover:bg-red-600 text-white py-3 px-4 rounded-xl font-semibold transition-colors flex items-center justify-center">
                                <i class="fas fa-times mr-2"></i>End
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Alert Container -->
    <div id="floating-alerts"></div>

    <script>
        class ProctoringDashboard {
            constructor() {
                // WebSocket configuration
                this.ws = null;
                this.isConnected = false;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 10;
                this.reconnectTimeout = null;

                // Camera configuration
                this.stream = null;
                this.videoElement = null;
                this.canvasElement = null;
                this.ctx = null;
                this.isCameraActive = false;
                this.cameraCheckInterval = null;

                // Performance monitoring
                this.lastFrameTime = null;
                this.frameCount = 0;
                this.currentLatency = 0;

                // Session management
                this.sessionStart = Date.now();
                this.activityLog = [];
                this.alertHistory = [];
                this.userData = null;
                this.currentStep = 1;

                // Simulated user database
                this.users = {
                    'student1@university.edu': { 
                        password: 'password123', 
                        role: 'student', 
                        name: 'John Smith',
                        studentId: 'S123456',
                        exams: ['Computer Science Final']
                    },
                    'demo@student.edu': { 
                        password: 'demo123', 
                        role: 'student', 
                        name: 'Demo Student',
                        studentId: 'S999999',
                        exams: ['Demo Examination']
                    }
                };

                // Exam database
                this.exams = {
                    'Computer Science Final': {
                        duration: '02:00:00',
                        questions: 50,
                        subject: 'Computer Science',
                        level: 'Advanced',
                        allowedAids: 'None',
                        maxScore: 100
                    },
                    'Demo Examination': {
                        duration: '01:00:00',
                        questions: 10,
                        subject: 'Demo Subject',
                        level: 'All Levels',
                        allowedAids: 'None',
                        maxScore: 100
                    }
                };

                this.initializeEventListeners();
                this.updateCurrentTime();
                setInterval(() => this.updateCurrentTime(), 1000);
                
                // Test server connection on startup
                this.testServerConnection();
                this.checkCameraAccess();
            }

            initializeEventListeners() {
                // Login form
                document.getElementById('login-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });

                // Logout button
                document.getElementById('logout-btn').addEventListener('click', () => {
                    this.handleLogout();
                });

                // Demo account buttons
                document.querySelectorAll('.demo-account-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const email = e.target.dataset.email;
                        const password = e.target.dataset.password;
                        document.getElementById('email').value = email;
                        document.getElementById('password').value = password;
                    });
                });

                // Test connection button
                document.getElementById('test-connection-btn').addEventListener('click', () => {
                    this.testServerConnection();
                });

                // Test camera button
                document.getElementById('test-camera-btn').addEventListener('click', () => {
                    this.checkCameraAccess(true);
                });

                // Setup wizard buttons
                document.getElementById('start-setup-btn').addEventListener('click', () => {
                    this.nextStep();
                });
                
                document.getElementById('request-camera-btn').addEventListener('click', () => {
                    this.requestCameraAccess();
                });
                
                document.getElementById('skip-camera-btn').addEventListener('click', () => {
                    this.nextStep();
                });
                
                document.getElementById('environment-confirm').addEventListener('change', (e) => {
                    document.getElementById('environment-next-btn').disabled = !e.target.checked;
                });
                
                document.getElementById('environment-next-btn').addEventListener('click', () => {
                    this.nextStep();
                });
                
                document.getElementById('start-exam-btn').addEventListener('click', () => {
                    this.startExam();
                });

                // Enable camera button
                document.getElementById('enable-camera-btn').addEventListener('click', () => {
                    this.startCamera();
                });

                // Check for remembered email
                const rememberedEmail = localStorage.getItem('rememberedEmail');
                if (rememberedEmail) {
                    document.getElementById('email').value = rememberedEmail;
                    document.getElementById('remember-me').checked = true;
                }
            }

            async checkCameraAccess(showAlert = false) {
                const statusElement = document.getElementById('camera-status-login');
                
                try {
                    // Check if browser supports mediaDevices API
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        statusElement.textContent = 'Not Supported';
                        statusElement.className = 'text-sm font-semibold text-red-600';
                        if (showAlert) {
                            this.showFloatingAlert('Camera API not supported in this browser', 'error');
                        }
                        return false;
                    }

                    // Try to access camera
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            frameRate: { ideal: 30 }
                        } 
                    });
                    
                    // Stop the stream immediately after testing
                    stream.getTracks().forEach(track => track.stop());
                    
                    statusElement.textContent = 'Available ✅';
                    statusElement.className = 'text-sm font-semibold text-green-600';
                    
                    if (showAlert) {
                        this.showFloatingAlert('Camera access confirmed!', 'success');
                    }
                    
                    return true;
                } catch (error) {
                    console.error('Camera access error:', error);
                    
                    let errorMessage = 'Camera access denied';
                    if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                        errorMessage = 'No camera found';
                    } else if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                        errorMessage = 'Camera permission denied';
                    } else if (error.name === 'NotSupportedError') {
                        errorMessage = 'Camera not supported';
                    } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                        errorMessage = 'Camera in use by another application';
                    }
                    
                    statusElement.textContent = errorMessage;
                    statusElement.className = 'text-sm font-semibold text-red-600';
                    
                    if (showAlert) {
                        this.showFloatingAlert(errorMessage, 'error');
                    }
                    
                    return false;
                }
            }

            async startCamera() {
                try {
                    this.videoElement = document.getElementById('webcam-video');
                    this.canvasElement = document.getElementById('webcam-canvas');
                    this.ctx = this.canvasElement.getContext('2d');
                    
                    // Get camera stream
                    this.stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            frameRate: { ideal: 30 }
                        } 
                    });
                    
                    // Set video source
                    this.videoElement.srcObject = this.stream;
                    
                    // Wait for video to load
                    await new Promise((resolve) => {
                        this.videoElement.onloadedmetadata = () => {
                            resolve();
                        };
                    });
                    
                    // Set canvas dimensions to match video
                    this.canvasElement.width = this.videoElement.videoWidth;
                    this.canvasElement.height = this.videoElement.videoHeight;
                    
                    // Show video and canvas, hide placeholder
                    this.videoElement.classList.remove('hidden');
                    this.canvasElement.classList.remove('hidden');
                    document.getElementById('video-placeholder').classList.add('hidden');
                    
                    this.isCameraActive = true;
                    this.updateCameraStatus(true);
                    
                    // Start processing frames
                    this.processVideoFrame();
                    
                    // Monitor camera status
                    this.startCameraMonitoring();
                    
                    this.addActivityLog('Camera activated successfully', 'system', 'green');
                    
                } catch (error) {
                    console.error('Error starting camera:', error);
                    this.updateCameraStatus(false);
                    this.addActivityLog('Failed to activate camera: ' + error.message, 'error', 'red');
                    
                    // Show error in placeholder
                    const placeholder = document.getElementById('video-placeholder');
                    placeholder.innerHTML = `
                        <div class="text-center">
                            <i class="fas fa-exclamation-triangle fa-3x mb-3 text-red-400"></i>
                            <p class="text-lg font-semibold mb-2 text-red-400">Camera Error</p>
                            <p class="text-sm mb-4">${error.message}</p>
                            <button id="retry-camera-btn" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg">
                                <i class="fas fa-redo mr-2"></i>Retry Camera
                            </button>
                        </div>
                    `;
                    
                    // Add event listener for retry button
                    document.getElementById('retry-camera-btn').addEventListener('click', () => {
                        this.startCamera();
                    });
                }
            }

            startCameraMonitoring() {
                // Clear existing interval
                if (this.cameraCheckInterval) {
                    clearInterval(this.cameraCheckInterval);
                }
                
                // Check camera status every 5 seconds
                this.cameraCheckInterval = setInterval(() => {
                    if (this.stream) {
                        const videoTrack = this.stream.getVideoTracks()[0];
                        if (!videoTrack || videoTrack.readyState === 'ended') {
                            this.updateCameraStatus(false);
                            this.addActivityLog('Camera disconnected', 'warning', 'yellow');
                            this.stopCamera();
                        }
                    }
                }, 5000);
            }

            stopCamera() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                
                if (this.cameraCheckInterval) {
                    clearInterval(this.cameraCheckInterval);
                    this.cameraCheckInterval = null;
                }
                
                this.isCameraActive = false;
                this.updateCameraStatus(false);
                
                // Show placeholder
                document.getElementById('video-placeholder').classList.remove('hidden');
                if (this.videoElement) this.videoElement.classList.add('hidden');
                if (this.canvasElement) this.canvasElement.classList.add('hidden');
            }

            updateCameraStatus(active) {
                const statusElement = document.getElementById('camera-status-dashboard');
                if (!statusElement) return;
                
                if (active) {
                    statusElement.textContent = 'Active ✅';
                    statusElement.className = 'text-green-400';
                } else {
                    statusElement.textContent = 'Inactive ❌';
                    statusElement.className = 'text-red-400';
                }
            }

            processVideoFrame() {
                if (!this.isCameraActive || !this.videoElement || !this.ctx) return;
                
                try {
                    // Draw current video frame to canvas
                    this.ctx.drawImage(
                        this.videoElement, 
                        0, 0, 
                        this.canvasElement.width, 
                        this.canvasElement.height
                    );
                    
                    // Process next frame
                    requestAnimationFrame(() => this.processVideoFrame());
                    
                    // Update performance metrics
                    this.updatePerformanceMetrics();
                    
                } catch (error) {
                    console.error('Error processing video frame:', error);
                }
            }

            async testServerConnection() {
                const statusElement = document.getElementById('server-status');
                const testBtn = document.getElementById('test-connection-btn');
                
                statusElement.textContent = 'Testing...';
                statusElement.className = 'text-sm font-semibold text-yellow-600';
                testBtn.disabled = true;
                testBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Testing...';

                try {
                    // Try to connect to WebSocket
                    const ws = new WebSocket('ws://localhost:8765');
                    
                    await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            ws.close();
                            reject(new Error('Connection timeout'));
                        }, 3000);

                        ws.onopen = () => {
                            clearTimeout(timeout);
                            ws.close();
                            resolve();
                        };

                        ws.onerror = () => {
                            clearTimeout(timeout);
                            reject(new Error('Connection failed'));
                        };
                    });

                    statusElement.textContent = 'Connected ✅';
                    statusElement.className = 'text-sm font-semibold text-green-600';
                    this.showFloatingAlert('Server connection successful!', 'success');
                    
                } catch (error) {
                    statusElement.textContent = 'Not Connected ❌';
                    statusElement.className = 'text-sm font-semibold text-red-600';
                    this.showFloatingAlert('Cannot connect to server. Make sure the server is running on port 8765.', 'error');
                } finally {
                    testBtn.disabled = false;
                    testBtn.innerHTML = '<i class="fas fa-plug mr-2"></i>Test Server Connection';
                }
            }

            handleLogin() {
                const email = document.getElementById('email').value.trim().toLowerCase();
                const password = document.getElementById('password').value;
                const rememberMe = document.getElementById('remember-me').checked;

                // Show loading state
                const submitBtn = document.querySelector('#login-form button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Authenticating...';
                submitBtn.disabled = true;

                // Simulate API call delay
                setTimeout(() => {
                    const authResult = this.authenticateUser(email, password);
                    
                    if (authResult.success) {
                        this.userData = authResult.userData;
                        
                        // Store login data if "Remember me" is checked
                        if (rememberMe) {
                            localStorage.setItem('rememberedEmail', email);
                        } else {
                            localStorage.removeItem('rememberedEmail');
                        }
                        
                        this.showSetupWizard();
                        this.showFloatingAlert(authResult.message, 'success');
                    } else {
                        this.showFloatingAlert(authResult.message, 'error');
                    }
                    
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }, 1500);
            }

            authenticateUser(email, password) {
                // Check if user exists
                if (!this.users[email]) {
                    return {
                        success: false,
                        message: 'Invalid email address. Please check your credentials.'
                    };
                }

                // Check password
                if (this.users[email].password !== password) {
                    return {
                        success: false,
                        message: 'Incorrect password. Please try again.'
                    };
                }

                const user = this.users[email];
                
                // Prepare user data
                let userData = {
                    email: email,
                    name: user.name,
                    role: user.role,
                    loginTime: new Date().toISOString(),
                    sessionId: this.generateSessionId()
                };

                // Add role-specific data
                if (user.role === 'student') {
                    userData.studentId = user.studentId;
                    userData.exams = user.exams;
                    userData.currentExam = user.exams[0];
                    userData.examData = this.exams[user.exams[0]];
                }

                return {
                    success: true,
                    userData: userData,
                    message: 'Welcome back, ' + user.name + '!'
                };
            }

            generateSessionId() {
                return 'session_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
            }

            handleLogout() {
                if (confirm('Are you sure you want to logout? This will end your exam session.')) {
                    this.addActivityLog('User logged out', 'system', 'blue');
                    this.hideDashboard();
                    this.disconnectWebSocket();
                    this.stopCamera();
                    document.getElementById('login-form').reset();
                    this.showFloatingAlert('You have been logged out successfully.', 'success');
                }
            }

            showSetupWizard() {
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('setup-wizard').classList.remove('hidden');
                
                // Update user info in setup
                document.getElementById('setup-user-name').textContent = this.userData.name;
                document.getElementById('setup-exam-name').textContent = this.userData.currentExam;
                document.getElementById('setup-exam-duration').textContent = this.userData.examData.duration;
                document.getElementById('setup-exam-questions').textContent = this.userData.examData.questions;
                
                this.currentStep = 1;
                this.updateStepIndicator();
            }

            nextStep() {
                this.currentStep++;
                this.updateStepIndicator();
                
                // Show the current step and hide others
                document.querySelectorAll('.step-content').forEach((el, index) => {
                    if (index + 1 === this.currentStep) {
                        el.classList.remove('hidden');
                        el.classList.add('fade-in');
                    } else {
                        el.classList.add('hidden');
                        el.classList.remove('fade-in');
                    }
                });
            }

            updateStepIndicator() {
                document.querySelectorAll('.step').forEach((el, index) => {
                    if (index + 1 < this.currentStep) {
                        el.classList.add('completed');
                        el.classList.remove('active');
                    } else if (index + 1 === this.currentStep) {
                        el.classList.add('active');
                        el.classList.remove('completed');
                    } else {
                        el.classList.remove('active', 'completed');
                    }
                });
            }

            async requestCameraAccess() {
                const cameraPreview = document.getElementById('camera-preview');
                const cameraPlaceholder = document.getElementById('camera-placeholder');
                const requestBtn = document.getElementById('request-camera-btn');
                
                requestBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Requesting...';
                requestBtn.disabled = true;
                
                try {
                    // Request camera access
                    const cameraStream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            facingMode: 'user'
                        } 
                    });
                    
                    // Display camera feed
                    cameraPreview.srcObject = cameraStream;
                    cameraPreview.classList.remove('hidden');
                    cameraPlaceholder.classList.add('hidden');
                    
                    requestBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Camera Active';
                    requestBtn.classList.remove('btn-primary');
                    requestBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                    
                    // Store the stream for later use
                    this.cameraStream = cameraStream;
                    
                    // Enable next step after a short delay
                    setTimeout(() => {
                        this.nextStep();
                    }, 2000);
                    
                } catch (error) {
                    console.error('Error accessing camera:', error);
                    cameraPlaceholder.innerHTML = `
                        <div class="text-center text-red-400">
                            <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                            <p>Camera access denied</p>
                            <p class="text-sm mt-2">Please allow camera access to continue</p>
                        </div>
                    `;
                    
                    requestBtn.innerHTML = '<i class="fas fa-camera mr-2"></i>Try Again';
                    requestBtn.disabled = false;
                    
                    this.showFloatingAlert('Camera access is required for proctored exams.', 'error');
                }
            }

            startExam() {
                this.showDashboard();
                this.initializeWebSocket();
                
                // Log exam start
                this.addActivityLog('Exam "' + this.userData.currentExam + '" started', 'system', 'blue');
                this.showFloatingAlert('Exam started successfully. Good luck!', 'success');
            }

            showDashboard() {
                document.getElementById('setup-wizard').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                
                // Update user info
                this.updateUserInterface();
                this.startSessionTimer();
                
                // Start camera if available
                if (this.cameraStream) {
                    this.startCamera();
                }
            }

            hideDashboard() {
                document.getElementById('login-page').classList.remove('hidden');
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('setup-wizard').classList.add('hidden');
            }

            updateUserInterface() {
                if (!this.userData) return;

                const userNameElement = document.getElementById('user-name');
                const examNameElement = document.getElementById('exam-name');
                const examTitleElement = document.getElementById('exam-title');
                const examDurationElement = document.getElementById('exam-duration');
                const examQuestionsElement = document.getElementById('exam-questions');
                const examStatusElement = document.getElementById('exam-status');

                // Update basic user info
                userNameElement.textContent = this.userData.name;

                if (this.userData.role === 'student') {
                    examNameElement.textContent = this.userData.currentExam;
                    examTitleElement.textContent = this.userData.currentExam;
                    examDurationElement.textContent = this.userData.examData.duration;
                    examQuestionsElement.textContent = this.userData.examData.questions;
                    examStatusElement.textContent = 'In Progress';
                    examStatusElement.className = 'font-semibold text-green-400';
                }
            }

            // WebSocket Management
            initializeWebSocket() {
                const wsUrl = 'ws://localhost:8765';
                
                // Close existing connection if any
                if (this.ws) {
                    this.ws.close();
                }

                // Clear any existing reconnect timeout
                if (this.reconnectTimeout) {
                    clearTimeout(this.reconnectTimeout);
                }

                console.log('🔗 Attempting to connect to WebSocket server...');
                this.ws = new WebSocket(wsUrl);

                // Connection established
                this.ws.onopen = (event) => {
                    console.log('✅ WebSocket connection established successfully');
                    this.isConnected = true;
                    this.reconnectAttempts = 0;
                    this.updateConnectionStatus(true);
                    this.addActivityLog('Connected to proctoring server', 'system', 'green');
                };

                // Message received
                this.ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.updateDashboard(data);
                    } catch (error) {
                        console.error('Error parsing WebSocket message:', error);
                    }
                };

                // Connection closed
                this.ws.onclose = (event) => {
                    console.log('🔌 WebSocket connection closed');
                    this.isConnected = false;
                    this.updateConnectionStatus(false);
                    
                    if (event.code !== 1000) {
                        this.addActivityLog('Connection lost', 'system', 'yellow');
                        this.handleReconnection();
                    }
                };

                // Connection error
                this.ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    this.isConnected = false;
                    this.updateConnectionStatus(false);
                };
            }

            handleReconnection() {
                if (this.reconnectAttempts >= this.maxReconnectAttempts) {
                    console.error('❌ Max reconnection attempts reached');
                    this.addActivityLog('Failed to reconnect after multiple attempts', 'error', 'red');
                    this.showReconnectionFailed();
                    return;
                }

                const baseDelay = 1000;
                const maxDelay = 30000;
                const delay = Math.min(baseDelay * Math.pow(1.5, this.reconnectAttempts), maxDelay);
                
                this.reconnectAttempts++;
                console.log('🔄 Reconnection attempt ' + this.reconnectAttempts + ' in ' + delay + 'ms');
                
                this.reconnectTimeout = setTimeout(() => {
                    this.initializeWebSocket();
                }, delay);
            }

            showReconnectionFailed() {
                const videoPlaceholder = document.getElementById('video-placeholder');
                if (videoPlaceholder) {
                    videoPlaceholder.innerHTML = `
                        <div class="text-center">
                            <i class="fas fa-exclamation-triangle fa-3x mb-3 text-red-400"></i>
                            <p class="text-red-400 font-semibold">Connection Failed</p>
                            <p class="text-gray-400 text-sm mt-2">Please refresh the page to try again</p>
                            <button onclick="location.reload()" class="bg-blue-500 text-white px-4 py-2 rounded mt-3">
                                Refresh Page
                            </button>
                        </div>
                    `;
                }
            }

            disconnectWebSocket() {
                if (this.ws) {
                    this.ws.close(1000, 'User logout');
                    this.ws = null;
                }
                if (this.reconnectTimeout) {
                    clearTimeout(this.reconnectTimeout);
                }
                this.isConnected = false;
            }

            updateConnectionStatus(connected) {
                const statusElement = document.getElementById('connection-status');
                const dot = statusElement.querySelector('.connection-dot');
                
                if (!statusElement) return;

                if (connected) {
                    dot.className = 'connection-dot connected';
                    statusElement.innerHTML = '<span class="connection-dot connected"></span>System Connected';
                    statusElement.className = 'text-green-300 font-semibold';
                } else {
                    dot.className = 'connection-dot disconnected';
                    statusElement.innerHTML = '<span class="connection-dot disconnected"></span>Connecting... (' + this.reconnectAttempts + '/' + this.maxReconnectAttempts + ')';
                    statusElement.className = 'text-red-300 font-semibold';
                }
            }

            updateDashboard(data) {
                try {
                    // Update system status first
                    this.updateSystemStatus(data);
                    
                    // Update data status
                    document.getElementById('data-status').textContent = 'Receiving live data...';
                    
                    // Update video feed
                    if (data.frame && data.frame.length > 0) {
                        this.updateVideoFeed(data.frame);
                    }
                    
                    // Update metrics
                    if (data.metrics) {
                        this.updateMetrics(data.metrics);
                        this.updateAlerts(data.metrics);
                        this.updateActivityLogFromMetrics(data.metrics);
                    }
                    
                    // Update performance metrics
                    this.updatePerformanceMetrics(data);
                    
                } catch (error) {
                    console.error('Error updating dashboard:', error);
                }
            }

            updateSystemStatus(data) {
                // Update detection status
                const detectionStatus = document.getElementById('detection-status');
                const facesCount = document.getElementById('faces-count');
                const stableFrames = document.getElementById('stable-frames');
                
                if (data.camera_status === 'real') {
                    detectionStatus.textContent = '🟢 REAL CAMERA';
                    detectionStatus.className = 'font-semibold text-green-400';
                } else {
                    detectionStatus.textContent = '🟡 SIMULATED';
                    detectionStatus.className = 'font-semibold text-yellow-400';
                }
                
                // Update faces count
                const facesDetected = data.faces_detected || 0;
                facesCount.textContent = facesDetected;
                facesCount.className = facesDetected > 0 ? 
                    'font-semibold text-green-400' : 'font-semibold text-red-400';
                
                // Update stable frames
                if (data.metrics && data.metrics.stable_frames) {
                    stableFrames.textContent = data.metrics.stable_frames + ' frames';
                }
            }

            updateVideoFeed(frameData) {
                const videoFeed = document.getElementById('webcam-canvas');
                const videoPlaceholder = document.getElementById('video-placeholder');
                
                if (!videoFeed || !videoPlaceholder) return;

                // Create an image from the base64 data
                const img = new Image();
                img.onload = () => {
                    // Draw the image to canvas
                    this.ctx.clearRect(0, 0, this.canvasElement.width, this.canvasElement.height);
                    this.ctx.drawImage(img, 0, 0, this.canvasElement.width, this.canvasElement.height);
                    
                    videoFeed.classList.remove('hidden');
                    videoPlaceholder.classList.add('hidden');
                };
                
                img.onerror = () => {
                    videoFeed.classList.add('hidden');
                    videoPlaceholder.classList.remove('hidden');
                    videoPlaceholder.innerHTML = `
                        <div class="text-center">
                            <i class="fas fa-exclamation-triangle fa-3x mb-3 text-yellow-400"></i>
                            <p class="text-yellow-400">Video feed error</p>
                        </div>
                    `;
                };

                img.src = 'data:image/jpeg;base64,' + frameData;
            }

            updateMetrics(metrics) {
                // Head pose
                const headYaw = Math.abs(metrics.head_yaw || 0);
                this.updateMetricElement('head-yaw-value', headYaw.toFixed(1) + '°', headYaw, 30);
                
                // Update head pose progress bar
                const headPercentage = Math.min((headYaw / 30) * 100, 100);
                this.updateProgressBar('head-yaw-bar', headPercentage, headYaw, 10, 20);

                // Eye gaze
                const gazeDeviation = metrics.gaze_deviation || 0;
                this.updateMetricElement('gaze-deviation-value', gazeDeviation.toFixed(3), gazeDeviation, 1.0);
                
                // Update gaze progress bar
                const gazePercentage = Math.min((gazeDeviation / 1.0) * 100, 100);
                this.updateProgressBar('gaze-deviation-bar', gazePercentage, gazeDeviation, 0.3, 0.6);

                // Device detection
                const deviceDetected = metrics.device_detected || false;
                this.updateDeviceStatus(deviceDetected);
            }

            updateMetricElement(elementId, value, currentValue, maxValue) {
                const element = document.getElementById(elementId);
                if (!element) return;

                element.textContent = value;

                // Update color based on value severity
                const severity = currentValue / maxValue;
                if (severity > 0.66) {
                    element.className = 'text-2xl font-bold text-red-400';
                } else if (severity > 0.33) {
                    element.className = 'text-2xl font-bold text-yellow-400';
                } else {
                    element.className = 'text-2xl font-bold text-green-400';
                }
            }

            updateProgressBar(elementId, percentage, currentValue, warningThreshold, dangerThreshold) {
                const element = document.getElementById(elementId);
                if (!element) return;

                element.style.width = percentage + '%';

                // Update color based on thresholds
                if (currentValue > dangerThreshold) {
                    element.className = 'progress-fill bg-red-400';
                } else if (currentValue > warningThreshold) {
                    element.className = 'progress-fill bg-yellow-400';
                } else {
                    element.className = 'progress-fill bg-green-400';
                }
            }

            updateDeviceStatus(deviceDetected) {
                const element = document.getElementById('device-status');
                if (!element) return;

                if (deviceDetected) {
                    element.textContent = 'DETECTED';
                    element.className = 'text-2xl font-bold text-red-400';
                } else {
                    element.textContent = 'CLEAR';
                    element.className = 'text-2xl font-bold text-green-400';
                }
            }

            updateAlerts(metrics) {
                const alertPanel = document.getElementById('alert-panel');
                const alertStatus = document.getElementById('alert-status');
                const alertMessage = document.getElementById('alert-message');
                const alertIcon = alertPanel.querySelector('i');

                if (!alertPanel || !alertStatus || !alertMessage) return;

                const hasAlert = metrics.alert_active || false;
                const facesDetected = metrics.faces_detected || 0;
                const latestAlert = metrics.latest_alert_type || '';

                if (hasAlert) {
                    // Alert state
                    alertPanel.className = 'glass-card rounded-2xl p-6 bg-red-500/20 border-red-400/30 alert-pulse';
                    alertStatus.textContent = 'ALERT!';
                    alertStatus.className = 'text-2xl font-bold text-red-400 mb-2';
                    alertIcon.className = 'fas fa-exclamation-triangle text-5xl text-red-400 mb-4';
                    alertMessage.textContent = latestAlert || 'Suspicious activity detected';

                    // Show floating alert for critical alerts
                    if (latestAlert.includes('MULTIPLE_FACES') || 
                        latestAlert.includes('DEVICE_DETECTED') ||
                        latestAlert.includes('TERMINATED')) {
                        this.showFloatingAlert(latestAlert, 'error');
                    }
                    
                } else if (facesDetected === 0) {
                    // No face detected warning
                    alertPanel.className = 'glass-card rounded-2xl p-6 bg-yellow-500/20 border-yellow-400/30';
                    alertStatus.textContent = 'WARNING';
                    alertStatus.className = 'text-2xl font-bold text-yellow-400 mb-2';
                    alertIcon.className = 'fas fa-exclamation-triangle text-5xl text-yellow-400 mb-4';
                    alertMessage.textContent = 'No face detected - please position yourself in camera view';
                } else {
                    // Clear state
                    alertPanel.className = 'glass-card rounded-2xl p-6 bg-green-500/20 border-green-400/30';
                    alertStatus.textContent = 'ALL CLEAR';
                    alertStatus.className = 'text-2xl font-bold text-green-400 mb-2';
                    alertIcon.className = 'fas fa-check-circle text-5xl text-green-400 mb-4';
                    alertMessage.textContent = 'No suspicious activity detected';
                }
            }

            updatePerformanceMetrics(data) {
                const now = Date.now();
                
                // Calculate frame rate
                if (!this.lastFrameTime) {
                    this.lastFrameTime = now;
                    this.frameCount = 0;
                }
                
                this.frameCount++;
                
                if (now - this.lastFrameTime >= 1000) {
                    const fps = Math.round((this.frameCount * 1000) / (now - this.lastFrameTime));
                    this.lastFrameTime = now;
                    this.frameCount = 0;
                    
                    // Update FPS display
                    document.getElementById('fps-display').textContent = fps;
                    document.getElementById('fps-display-main').textContent = fps + ' FPS';
                }
            }

            // Activity Log Management
            addActivityLog(message, type = 'system', color = 'blue') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = {
                    timestamp: timestamp,
                    message: message,
                    type: type,
                    color: color
                };

                this.activityLog.unshift(logEntry);
                
                // Keep only last 20 entries
                if (this.activityLog.length > 20) {
                    this.activityLog = this.activityLog.slice(0, 20);
                }

                this.updateActivityLogUI();
            }

            updateActivityLogFromMetrics(metrics) {
                const facesDetected = metrics.faces_detected || 0;
                const movementDetected = metrics.movement_detected || false;
                const alertActive = metrics.alert_active || false;
                const stableFrames = metrics.stable_frames || 0;
                const latestAlert = metrics.latest_alert_type || '';

                // Face detection alerts
                if (facesDetected === 0 && !this.alertHistory.includes('no_face')) {
                    this.addActivityLog('No face detected - please position yourself in frame', 'alert', 'red');
                    this.alertHistory.push('no_face');
                } else if (facesDetected > 0 && this.alertHistory.includes('no_face')) {
                    this.addActivityLog('Face detected successfully', 'system', 'green');
                    this.alertHistory = this.alertHistory.filter(a => a !== 'no_face');
                }

                // Movement alerts
                if (movementDetected && !this.alertHistory.includes('movement')) {
                    this.addActivityLog('Significant movement detected', 'warning', 'yellow');
                    this.alertHistory.push('movement');
                } else if (!movementDetected && this.alertHistory.includes('movement')) {
                    this.alertHistory = this.alertHistory.filter(a => a !== 'movement');
                }

                // Alert logging
                if (alertActive && latestAlert && !this.alertHistory.includes(latestAlert)) {
                    this.addActivityLog(latestAlert, 'alert', 'red');
                    this.alertHistory.push(latestAlert);
                    
                    // Remove old alerts from history
                    if (this.alertHistory.length > 5) {
                        this.alertHistory.shift();
                    }
                }

                // Stability milestones
                if (stableFrames === 10 && !this.alertHistory.includes('stable_10')) {
                    this.addActivityLog('Face stable for 10 frames', 'info', 'blue');
                    this.alertHistory.push('stable_10');
                }
                if (stableFrames === 30 && !this.alertHistory.includes('stable_30')) {
                    this.addActivityLog('Face stable for 30 frames - good focus!', 'info', 'green');
                    this.alertHistory.push('stable_30');
                }

                // Multiple faces alert
                if (facesDetected > 1 && !this.alertHistory.includes('multiple_faces')) {
                    this.addActivityLog('Multiple faces detected in frame', 'warning', 'yellow');
                    this.alertHistory.push('multiple_faces');
                } else if (facesDetected <= 1 && this.alertHistory.includes('multiple_faces')) {
                    this.alertHistory = this.alertHistory.filter(a => a !== 'multiple_faces');
                }
            }

            updateActivityLogUI() {
                const logContainer = document.getElementById('activity-log');
                if (!logContainer) return;

                logContainer.innerHTML = '';

                this.activityLog.forEach(entry => {
                    const logElement = document.createElement('div');
                    const colorClass = this.getColorClass(entry.color);
                    logElement.className = 'border-l-4 pl-3 py-1 mb-2 ' + colorClass.border + ' ' + colorClass.text;
                    logElement.innerHTML = `
                        <i class="fas fa-${entry.type === 'alert' ? 'exclamation-triangle' : 
                                          entry.type === 'warning' ? 'exclamation-circle' : 
                                          entry.type === 'info' ? 'info-circle' : 'check-circle'} mr-2"></i>
                        <span class="font-mono">[${entry.timestamp}]</span> ${entry.message}
                    `;
                    logContainer.appendChild(logElement);
                });
            }

            getColorClass(color) {
                const colors = {
                    green: { border: 'border-green-400', text: 'text-green-400' },
                    red: { border: 'border-red-400', text: 'text-red-400' },
                    yellow: { border: 'border-yellow-400', text: 'text-yellow-400' },
                    blue: { border: 'border-blue-400', text: 'text-blue-400' }
                };
                return colors[color] || colors.blue;
            }

            // Session Management
            startSessionTimer() {
                this.sessionStart = Date.now();
                setInterval(() => {
                    const elapsed = Date.now() - this.sessionStart;
                    const hours = Math.floor(elapsed / 3600000);
                    const minutes = Math.floor((elapsed % 3600000) / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    
                    document.getElementById('session-timer').textContent = 
                        hours.toString().padStart(2, '0') + ':' + 
                        minutes.toString().padStart(2, '0') + ':' + 
                        seconds.toString().padStart(2, '0');
                }, 1000);
            }

            updateCurrentTime() {
                const now = new Date();
                document.getElementById('current-time').textContent = now.toLocaleTimeString();
            }

            // UI Helpers
            showFloatingAlert(message, type = 'info') {
                const alertContainer = document.getElementById('floating-alerts');
                const alertId = 'alert-' + Date.now();
                
                const alertDiv = document.createElement('div');
                alertDiv.id = alertId;
                
                let bgColor, icon, textColor;
                
                switch (type) {
                    case 'success':
                        bgColor = 'bg-green-500';
                        icon = 'fa-check-circle';
                        textColor = 'text-white';
                        break;
                    case 'error':
                        bgColor = 'bg-red-500';
                        icon = 'fa-exclamation-triangle';
                        textColor = 'text-white';
                        break;
                    case 'warning':
                        bgColor = 'bg-yellow-500';
                        icon = 'fa-exclamation-circle';
                        textColor = 'text-white';
                        break;
                    default:
                        bgColor = 'bg-blue-500';
                        icon = 'fa-info-circle';
                        textColor = 'text-white';
                }
                
                alertDiv.className = 'floating-alert ' + bgColor + ' ' + textColor + ' p-4 rounded-lg shadow-lg max-w-sm';
                alertDiv.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas ${icon} mr-3"></i>
                        <span class="flex-1">${message}</span>
                        <button onclick="document.getElementById('${alertId}').remove()" class="ml-4">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                
                alertContainer.appendChild(alertDiv);
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    const alertElement = document.getElementById(alertId);
                    if (alertElement) {
                        alertElement.remove();
                    }
                }, 5000);
            }
        }

        // Initialize the dashboard when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.proctoringDashboard = new ProctoringDashboard();
        });
    </script>
</body>
</html>
